---
lab:
  az204Title: 'Lab 02: Implement task processing logic by using Azure Functions'
  az204Module: 'Module 02: Implement Azure Functions'
---

# <a name="lab-02-implement-task-processing-logic-by-using-azure-functions"></a>實驗室 02：使用 Azure Functions 實作工作處理邏輯

## <a name="microsoft-azure-user-interface"></a>Microsoft Azure 使用者介面

基於 Microsoft 雲端工具的動態性質，您可能會遇到在本訓練內容開發後變更的 Azure UI。 因此，實驗指示可能無法正確對應實驗步驟。

當社群提醒 Microsoft 需要做修改時，我們會更新此訓練課程。 然而，雲端更新經常發生，所以您可能會在此訓練內容更新前遇到 UI 的變更。 **如果發生這種情況，請適應變更，然後視需要在實驗中調整。**

## <a name="instructions"></a>Instructions

### <a name="before-you-start"></a>在您開始使用 Intune 之前

#### <a name="sign-in-to-the-lab-environment"></a>登入實驗室環境

使用下列認證登入您的 Windows 10 虛擬機器 (VM)：

- 使用者名稱：**系統管理員**
- 密碼：**Pa55w.rd**

> **注意**：您的講師會提供連線至虛擬實驗室環境的指示。

#### <a name="review-the-installed-applications"></a>檢閱已安裝的應用程式

尋找 Windows 10 桌面上的工作列。 工作列包含此次實驗中會用到的應用程式圖示，包括：

- Microsoft Edge
- 檔案總管
- Windows 終端機
- Visual Studio Code

## <a name="architecture-diagram"></a>架構圖

![說明使用 Azure Functions 實作工作處理邏輯的使用者結構圖。](./media/Lab02-Diagram.png)

### <a name="exercise-1-create-azure-resources"></a>練習 1：建立 Azure 資源

#### <a name="task-1-open-the-azure-portal"></a>工作 1：開啟 Azure 入口網站

1. 在工作列上，選取 **Microsoft Edge** 圖示。
1. 在瀏覽器視窗中，瀏覽至 Azure 入口網站 (<https://portal.azure.com>)，然後登入您在此實驗要用的帳戶。

    > **注意**：如果這是您第一次登入 Azure 入口網站，系統會提供入口網站的導覽。 如果您想要跳過導覽，請選取 [開始使用] 即可開始使用入口網站。

#### <a name="task-2-create-an-azure-storage-account"></a>工作 2：建立 Azure 儲存體帳戶

1. 在 Azure 入口網站中，使用 [搜尋資源、服務和文件] 文字輸入框，搜尋**儲存體帳戶**，然後在結果清單中選取 [儲存體帳戶]。

1. 在 [儲存體帳戶] **** 刀鋒視窗上，選取 [+ 建立]。

1. 在 [建立儲存體帳戶] 刀鋒視窗的 [基本] 索引標籤上，執行下列動作，然後選取 [檢閱]：

    | 設定 | 動作 |
    | -- | -- |
    | [訂閱] 下拉式清單 | 保留預設值 |
    | [資源群組] 區段 | 選取 [新建]，輸入 **Serverless**，然後選取 [確定] |
    | [儲存體帳戶名稱] 文字輸入框 | 輸入 **funcstor** _[您的名稱]_ |
    | [區域] 下拉式清單 | 選取 **(美國) 美國東部** |
    | [效能] 區段 | 選取 [標準] 選項 |
    | [備援] 下拉式清單 | 選取 [本地備援儲存體 (LRS)] |

    下列螢幕擷取畫面顯示 [建立儲存體帳戶] 窗格中的設定。

    ![顯示 [建立儲存體帳戶] 窗格中設定的螢幕擷取畫面](./media/l02_create_a_storage_account.png)

1. 在 [檢閱] 索引標籤上，檢閱您在先前步驟中選取的選項。

1. 選取 [建立]，使用您指定的設定來建立儲存體帳戶。

    > **注意**：等候建立工作完成，再繼續進行實驗。

1. 在 [概觀] 窗格上，選取 [前往資源] 按鈕，即可瀏覽至新建的 [儲存體帳戶] 窗格。

1. 在 [儲存體帳戶] **** 刀鋒視窗的 [安全性 + 網路] **** 區段中，選取 [存取金鑰]。

1. 在 [存取金鑰] **** 刀鋒視窗上，選取 [顯示金鑰]。

1. 檢閱任一金鑰，然後將其中一個 [連接字串] **** 方塊的值複製到剪貼簿。

     > **注意**：無論您選擇哪個連接字串都不會有影響。 它們是可互換的。

1. 開啟記事本，然後將複製的連接字串值貼到記事本。 您會在稍後的實驗中用到此值。

#### <a name="task-3-create-a-function-app"></a>工作 3：建立函數應用程式

1. 在 Azure 入口網站的 [瀏覽] 窗格上，選取 [建立資源] 連結。

1. 在 [建立資源] 窗格上的 [搜尋服務和市集] 文字輸入框中，輸入 **Function** 再選取 [輸入]。

1. 在 [市集] 搜尋結果窗格上，選取 [函數應用程式] 結果。

1. 在 [函數應用程式] 窗格上，選取 [建立]。

1. 在 [建立函數應用程式] 窗格的 [基本] 索引標籤上，執行下列動作，然後選取 [下一步：裝載]：

    | 設定 | 動作 |
    | -- | -- |
    | [訂閱] 下拉式清單 | 保留預設值 |
    | [資源群組] 區段 | 選取 [無伺服器] |
    | [函數應用程式名稱] 文字輸入框 | 輸入 **funclogic** _[您的名稱]_ |
    | [發佈] 區段 | 選取 [程式碼] |
    | [執行階段堆疊] 下拉式清單 | 選取 **.NET** |
    | [版本] 下拉式清單 | 選取 **6** |
    | [區域] 下拉式清單 | 選取 [美國東部] 區域 |
    | [作業系統] 選項 | 選取 [Linux] |
    | [方案類型] 下拉式清單 | 選取 [使用量 (無伺服器)] |

    下列螢幕擷取畫面顯示 [建立函數應用程式] 窗格上的設定。

    ![顯示 [建立函數應用程式] 窗格上設定的螢幕擷取畫面](./media/l02_create_a_function_app.png)

1. 在 [裝載] 索引標籤上執行下列動作，然後選取 [檢閱 + 建立]：

    | 設定 | 動作 |
    | -- | -- |
    | [儲存體帳戶] 下拉式清單 | 選取 **funcstor** _[您的名稱]_ 儲存體帳戶 |

1. 在 [檢閱 + 建立] 索引標籤上，檢閱在先前步驟中選取的選項。

1. 選取 [建立]，使用您指定的設定來建立函數應用程式。

    > **注意**：等候建立工作完成，再繼續進行實驗。

#### <a name="review"></a>檢閱

在此練習中，您建立了要在此實驗中使用的所有資源。

### <a name="exercise-2-configure-a-local-azure-functions-project"></a>練習 2：設定本機 Azure Functions 專案

#### <a name="task-1-initialize-a-function-project"></a>工作 1：初始化函數專案

1. 在工作列上，選取 **Windows 終端機**圖示。

1. 執行下列命令，將目前目錄變更為 **Allfiles (F):\\Allfiles\\Labs\\02\\Starter\\func** 空白目錄：

    ```powershell
    cd F:\Allfiles\Labs\02\Starter\func
    ```

    > **注意**：在 Windows Explorer 中，從 **F:\\Allfiles\\Labs\\02\\Starter\\func\\.gitignore** 檔案中移除 [唯讀] 屬性。

1. 執行下列命令，使用 **Azure Functions Core Tools** 透過 **dotnet** 執行階段在目前的目錄中建立新的本機 Azure Functions 專案：

    ```powershell
    func init --worker-runtime dotnet --force
    ```

    > **注意**：您可以使用 **Azure Functions Core Tools** 檢閱文件以 [建立新專案][azure-functions-core-tools-new-project]。
    
1. 關閉 **Windows 終端機**應用程式。

#### <a name="task-2-configure-a-connection-string"></a>工作 2：設定連接字串

1. 在 [開始] 畫面上選取 [Visual Studio Code] 圖格。 
1. 在 [檔案]**** 功能表上，選取 [開啟資料夾]****。
1. 在開啟的 [檔案總管] 視窗中，瀏覽至 **Allfiles (F):\\Allfiles\\Labs\\02\\Starter\\func**，然後選取 [選取資料夾]。
1. 在 [Visual Studio Code] 視窗的 [Explorer] 窗格上，開啟 **local.settings.json** 檔案。
1. 觀察 **AzureWebJobsStorage** 目前的設定值：

    ```json
    "AzureWebJobsStorage": "UseDevelopmentStorage=true",
    ```

1. 變更 **AzureWebJobsStorage** 元素的值，將其設為您稍早在此實驗中記錄的儲存體帳戶**連接字串**。
1. 開啟 **local.settings.json** 檔案。

#### <a name="task-3-build-and-validate-a-project"></a>工作 3：組建並驗證專案

1. 在工作列上，選取 **Windows 終端機**圖示。
1. 執行下列命令，將目前目錄變更為 **Allfiles (F):\\Allfiles\\Labs\\02\\Starter\\func** 目錄：

    ```powershell
    cd F:\Allfiles\Labs\02\Starter\func
    ```

1. 執行下列命令來**組建** .NET Core 3.1 專案：

    ```powershell
    dotnet build
    ```

#### <a name="review"></a>檢閱

在本練習中，您建立了將用來開發 Azure Functions 的本機專案。

### <a name="exercise-3-create-a-function-thats-triggered-by-an-http-request"></a>練習 3：建立由 HTTP 要求所觸發的函數

#### <a name="task-1-create-an-http-triggered-function"></a>工作 1：建立 HTTP 觸發函數

1. 在工作列上，選取 **Windows 終端機**圖示。
1. 執行下列命令，將目前目錄變更為 **Allfiles (F):\\Allfiles\\Labs\\02\\Starter\\func** 目錄：

    ```powershell
    cd F:\Allfiles\Labs\02\Starter\func
    ```

1. 執行下列命令，使用 **Azure Functions Core Tools** 透過 **HTTP trigger**範本來建立名為 **Echo** 的新函數：

    ```powershell
    func new --template "HTTP trigger" --name "Echo"
    ```

    > **注意**：您可以使用 **Azure Functions Core Tools** 檢閱文件以 [建立新函數][azure-functions-core-tools-new-function]。

1. 關閉目前執行中的 **Windows 終端機**應用程式。

#### <a name="task-2-write-http-triggered-function-code"></a>工作 2：寫入 HTTP 觸發的函數程式碼

1. 在 [開始] 畫面上選取 [Visual Studio Code] 圖格。 
1. 在 [檔案]**** 功能表上，選取 [開啟資料夾]****。
1. 在開啟的 [檔案總管] 視窗中，瀏覽至 **Allfiles (F):\\Allfiles\\Labs\\02\\Starter\\func**，然後選取 [選取資料夾]。
1. 在 [Visual Studio Code] 視窗的 [Explorer] 窗格中，開啟 **Echo.cs** 檔案。
1. 在程式碼編輯器中觀察範例實作情況：

    ```csharp
    using System;
    using System.IO;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Azure.WebJobs;
    using Microsoft.Azure.WebJobs.Extensions.Http;
    using Microsoft.AspNetCore.Http;
    using Microsoft.Extensions.Logging;
    using Newtonsoft.Json;
    namespace func
    {
        public static class Echo
        {
            [FunctionName("Echo")]
            public static async Task<IActionResult> Run(
                [HttpTrigger(AuthorizationLevel.Function, "get", "post", Route = null)] HttpRequest req,
                ILogger log)
            {
                log.LogInformation("C# HTTP trigger function processed a request.");
                string name = req.Query["name"];
                string requestBody = await new StreamReader(req.Body).ReadToEndAsync();
                dynamic data = JsonConvert.DeserializeObject(requestBody);
                name = name ?? data?.name;
                string responseMessage = string.IsNullOrEmpty(name)
                    ? "This HTTP triggered function executed successfully. Pass a name in the query string or in the request body for a personalized response."
                    : $"Hello, {name}. This HTTP triggered function executed successfully.";
                return new OkObjectResult(responseMessage);
            }
        }
    }
    ```

1. 刪除 **Echo.cs** 檔案內的所有內容。
1. 新增下列程式碼，在 **Microsoft.AspNetCore.Mvc**、**Microsoft.Azure.WebJobs**、**Microsoft.AspNetCore.Http** 和 **Microsoft.Extensions.Logging** 命名空間中新增 **Using 指示詞**：

    ```csharp
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Azure.WebJobs;
    using Microsoft.AspNetCore.Http;
    using Microsoft.Extensions.Logging;
    ```

1. 建立名為 **Echo** 的新**public static**類別：

    ```csharp
    public static class Echo
    { }
    ```

1. 再次觀察 **Echo.cs** 檔案，現在應該包含：

    ```csharp
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Azure.WebJobs;
    using Microsoft.AspNetCore.Http;
    using Microsoft.Extensions.Logging;
    public static class Echo
    { }
    ```

1. 在 **Echo** 類別中新增下列程式碼區塊，建立名為 **Run** 的新**public static**方法以傳回 **IActionResult** 類型的變數，並接受 **HttpRequest** 和 **ILogger** 型別的變數作為參數，分別名為 request和 logger：

    ```csharp
    public static IActionResult Run(
        HttpRequest request,
        ILogger logger)
    { }
    ```

1. 新增下列程式碼，將屬性附加至 **FunctionNameAttribute** 型別的 **Run** 方法，其**名稱**參數的值設為 **Echo**：

    ```csharp
    [FunctionName("Echo")]
    public static IActionResult Run(
        HttpRequest request,
        ILogger logger)
    { }
    ```

1. 新增下列程式碼，將屬性附加至 **HttpTriggerAttribute** 型別的**要求**參數，其**方法**參數陣列設為單一值 **POST**：

    ```csharp
    [FunctionName("Echo")]
    public static IActionResult Run(
        [HttpTrigger("POST")] HttpRequest request,
        ILogger logger)
    { }
    ```

1. 再次觀察 **Echo.cs** 檔案，現在應該包含下列程式碼：

    ```csharp
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Azure.WebJobs;
    using Microsoft.AspNetCore.Http;
    using Microsoft.Extensions.Logging;
    public static class Echo
    {
        [FunctionName("Echo")]
        public static IActionResult Run(
            [HttpTrigger("POST")] HttpRequest request,
            ILogger logger)
        { }
    }
    ```

1. 在 **Run** 方法中輸入下列程式碼來記錄固定訊息：

    ```csharp
    logger.LogInformation("Received a request");
    ```

1. 輸入下列程式碼，將 HTTP 要求的本文回應為 HTTP 的回應內容：

    ```csharp
    return new OkObjectResult(request.Body);
    ```

1. 再次觀察 **Echo.cs** 檔案，現在應該包含下列程式碼：

    ```csharp
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Azure.WebJobs;
    using Microsoft.AspNetCore.Http;
    using Microsoft.Extensions.Logging;
    public static class Echo
    {
        [FunctionName("Echo")]
        public static IActionResult Run(
            [HttpTrigger("POST")] HttpRequest request,
            ILogger logger)
        {
            logger.LogInformation("Received a request");
            return new OkObjectResult(request.Body);
        }
    }
    ```

1. 選取 [儲存] 即可將您的變更儲存至 **Echo.cs** 檔案。

#### <a name="task-3-test-the-http-triggered-function-by-using-httprepl"></a>工作 3：使用 httprepl 來測試 HTTP 觸發函數

1. 在工作列上，選取 **Windows 終端機**圖示。
1. 執行下列命令，將目前目錄變更為 **Allfiles (F):\\Allfiles\\Labs\\02\\Starter\\func** 目錄：

    ```powershell
    cd F:\Allfiles\Labs\02\Starter\func
    ```

1. 執行下列命令以執行函數應用程式專案：

    ```powershell
    func start --build
    ```

    > **注意**：您可以使用 [Azure Functions Core Tools](https://docs.microsoft.com/azure/azure-functions/functions-develop-local) 檢閱文件以**在本機啟動函數應用程式專案**。
    
1. 在工作列上，再次選取 **Windows 終端機** 圖示以開啟應用程式的新執行個體。 執行下列命令，將目前目錄變更為 **Allfiles (F):\\Allfiles\\Labs\\02\\Starter\\func** 空白目錄：

    ```powershell
    cd F:\Allfiles\Labs\02\Starter\func
    ```
    
1. 從命令提示字元中，執行下列命令來安裝並啟動 **httprepl** 工具，將基礎統一資源識別項 (URI) 設為 ``http://localhost:7071``：

    ```powershell
    dotnet tool install -g Microsoft.dotnet-httprepl
    httprepl http://localhost:7071
    ```

    > **注意**：**httprepl** 工具會顯示錯誤訊息。 會出現此訊息是因為該工具會搜尋要用來周遊 API 的 Swagger 定義檔。 您的函數專案不會產生 Swagger 定義檔，因此您必須手動周遊 API。
1. 從工具提示中，執行下列命令來瀏覽至相應的 **api** 目錄：

    ```powershell
    cd api
    ```

1. 執行下列命令以瀏覽至相應的 **echo** 目錄：

    ```powershell
    cd echo
    ```

1. 執行下列命令以執行 **Post** 命令，使用 **\-\-content** 選項傳送數值設為 **3** 的 HTTP 要求本文：

    ```powershell
    post --content 3
    ```

1. 執行下列命令以執行 **Post** 命令，使用 **\-\-content** 選項傳送數值設為 **5** 的 HTTP 要求本文：

    ```powershell
    post --content 5
    ```

1. 執行下列命令以執行 **Post** 命令，使用 **\-\-content** 選項傳送字串值設為 **Hello** 的 HTTP 要求本文：

    ```powershell
    post --content "Hello"
    ```

1. 執行下列命令以執行 **Post** 命令，傳送 JavaScript 物件標記 (JSON) 值設為 **{"msg": "Successful"}** 的 HTTP 要求本文。方法是使用 **\-\-content** 選項：

    ```powershell
    post --content "{"msg": "Successful"}"
    ```

1. 執行下列命令即可結束 **httprepl** 應用程式：

    ```powershell
    exit
    ```

1. 關閉 **Windows 終端機**應用程式目前執行中的所有執行個體。

#### <a name="review"></a>檢閱

在此練習中，您建立了基本函數，該函數可回應透過 HTTP POST 要求傳送的內容。

### <a name="exercise-4-create-a-function-that-triggers-on-a-schedule"></a>練習 4：建立會依排程觸發的函數

#### <a name="task-1-create-a-schedule-triggered-function"></a>工作 1：建立排程觸發的函數

1. 在工作列上，選取 **Windows 終端機**圖示。
1. 執行下列命令，將目前目錄變更為 **Allfiles (F):\\Allfiles\\Labs\\02\\Starter\\func** 目錄：

    ```powershell
    cd F:\Allfiles\Labs\02\Starter\func
    ```

1. 從命令提示字元中，執行下列命令，使用 **Azure Functions Core Tools** 與**計時器觸發程序**範本，建立名稱為 **Recurring** 的新函式：

    ```powershell
    func new --template "Timer trigger" --name "Recurring"
    ```

    > **注意**：您可以使用 **Azure Functions Core Tools** 檢閱文件以 [建立新函數][azure-functions-core-tools-new-function]。
    
1. 關閉目前執行中的 **Windows 終端機**應用程式。

#### <a name="task-2-observe-function-code"></a>工作 2：觀察函數程式碼

1. 在 [開始] 畫面上選取 [Visual Studio Code] 圖格。 
1. 在 [檔案]**** 功能表上，選取 [開啟資料夾]****。
1. 在開啟的 [檔案總管] 視窗中，瀏覽至 **Allfiles (F):\\Allfiles\\Labs\\02\\Starter\\func**，然後選取 [選取資料夾]。
1. 在 [Visual Studio Code] 視窗的 [Explorer] 窗格中，開啟 **Recurring.cs** 檔案。
1. 在程式碼編輯器中觀察實際情況：

    ```csharp
    using System;
    using Microsoft.Azure.WebJobs;
    using Microsoft.Azure.WebJobs.Host;
    using Microsoft.Extensions.Logging;    
    namespace func
    {
        public static class Recurring
        {
            [FunctionName("Recurring")]
            public static void Run([TimerTrigger("0 */5 * * * *")]TimerInfo myTimer, ILogger log)
            {
                log.LogInformation($"C# Timer trigger function executed at: {DateTime.Now}");
            }
        }
    }
    ```

#### <a name="task-3-observe-function-runs"></a>工作 3：觀察函數執行狀況

1. 在工作列上，選取 **Windows 終端機**圖示。
1. 執行下列命令，將目前目錄變更為 **Allfiles (F):\\Allfiles\\Labs\\02\\Starter\\func** 目錄：

    ```powershell
    cd F:\Allfiles\Labs\02\Starter\func
    ```

1. 從命令提示字元中，執行下列命令來執行函數應用程式專案：

    ```powershell
    func start --build
    ```

    > **注意**：您可以使用 **Azure Functions Core Tools** 檢閱文件以 [在本機啟動函數應用程式專案][azure-functions-core-tools-start-function]。
1. 觀察大約每五分鐘會執行一次的函數。 每個函數執行時都應將簡單的訊息轉譯至記錄。
1. 關閉目前執行中的 **Windows 終端機**應用程式。

#### <a name="task-4-update-the-function-integration-configuration"></a>工作 4：更新函數整合設定

1. 在 [開始] 畫面上選取 [Visual Studio Code] 圖格。 
1. 在 [檔案]**** 功能表上，選取 [開啟資料夾]****。
1. 在開啟的 [檔案總管] 視窗中，瀏覽至 **Allfiles (F):\\Allfiles\\Labs\\02\\Starter\\func**，然後選取 [選取資料夾]。
1. 在 [Visual Studio Code] 視窗的 [Explorer] 窗格中，開啟 **Recurring.cs** 檔案。
1. 在程式碼編輯器中觀察現有的 **Run** 方法簽章：

    ```csharp
    [FunctionName("Recurring")]
    public void Run([TimerTrigger("0 */5 * * * *")]TimerInfo myTimer, ILogger log)
    ```

1. 更新 **Run** 方法簽章程式碼區塊，將排程變更為每 **30 秒**執行一次：

    ```csharp
    [FunctionName("Recurring")]
    public void Run([TimerTrigger("*/30 * * * * *")]TimerInfo myTimer, ILogger log)
    ```

1. 選取 [儲存] 即可將您的變更儲存至 **Recurring.cs** 檔案。

#### <a name="task-5-observe-function-runs"></a>工作 5：觀察函數執行狀況

1. 在工作列上，選取 **Windows 終端機**圖示。

1. 執行下列命令，將目前目錄變更為 **Allfiles (F):\\Allfiles\\Labs\\02\    \Starter\\func** 目錄：

    ```powershell
    cd F:\Allfiles\Labs\02\Starter\func
    ```

1. 1. 從命令提示字元中，執行下列命令來執行函數應用程式專案：

    ```powershell
    func start --build
    ```
    
    > **注意**：您可以使用 **Azure Functions Core Tools** 檢閱文件以 [在本機啟動函數應用程式專案][azure-functions-core-tools-start-function]。
    
1. 觀察大約每 30 秒會執行一次的函數。 每個函數執行時都應將簡單的訊息轉譯至記錄。

1. 關閉目前執行中的 **Windows 終端機**應用程式。

1. 關閉 Visual Studio Code 視窗。

#### <a name="review"></a>檢閱

在此練習中，您建立了根據固定排程自動執行的函數。

### <a name="exercise-5-create-a-function-that-integrates-with-other-services"></a>練習 5：建立與其他服務整合的函數

#### <a name="task-1-upload-sample-content-to-azure-blob-storage"></a>工作 1：將範例內容上傳至 Azure Blob 儲存體

1. 在 Azure 入口網站的 [瀏覽] 窗格上，選取 [資源群組] 連結。
1. 在 [資源群組] 窗格上，選取之前在此實驗中建立的 [Serverless] 資源群組。
1. 在 [Serverless] 窗格上，選取您先前在此實驗中建立的 **funcstor**[您的名稱] 儲存體帳戶。
1. 在 [儲存體帳戶] 窗格的 [資料儲存體] 區段中，選取 [容器] 連結。
1. 在 [容器] 區段中選取 [+ 容器]。
1. 在 [新增容器] 快顯視窗中執行下列動作，然後選取 [建立]：

    | 設定 | 動作 |
    | -- | -- |
    | [名稱] 文字輸入框  | 輸入 **content** |
    | [公用存取層級] 下拉式清單  | 選取 [私人] \(無匿名存取\) |

1. 返回 [容器] 區段，然後選取最近建立的**content**容器。
1. 在 [容器] 窗格上，選取 [上傳]。
1. 在 [上傳 blob] 視窗中，執行下列動作，然後選取 [上傳]：

    | 設定 | 動作 |
    | -- | -- |
    | [檔案] 區段  | 選取**資料夾**圖示 |
    | [檔案總管] 視窗  | 瀏覽至 **Allfiles (F):\\Allfiles\\Labs\\02\\Starter**，選取 **settings.json** 檔案，然後選取 [開啟] |
    | [如果檔案已存在即覆寫檔案] 核取方塊 | 請務必選取此核取方塊 |

      > **注意**：等候 blob 上傳後，再繼續實驗。

#### <a name="task-2-create-an-http-triggered-function"></a>工作 2：建立 HTTP 觸發函數

1. 在工作列上，選取 **Windows 終端機**圖示。
1. 執行下列命令，將目前目錄變更為 **Allfiles (F):\\Allfiles\\Labs\\02\\Starter\\func** 目錄：

    ```powershell
    cd F:\Allfiles\Labs\02\Starter\func
    ```

1. 從命令提示字元中，執行下列命令，使用 **Azure Functions Core Tools** 與 **HTTP 觸發程序**範本，建立名稱為 **GetSettingInfo** 的新函式：

    ```powershell
    func new --template "HTTP trigger" --name "GetSettingInfo"
    ```

    > **注意**：您可以使用 **Azure Functions Core Tools** 檢閱文件以 [建立新函數][azure-functions-core-tools-new-function]。
1. 關閉目前執行中的 **Windows 終端機**應用程式。

#### <a name="task-3-write-http-triggered-and-blob-inputted-function-code"></a>工作 3：寫入 HTTP 觸發和 Blob 輸入函式程式碼

1. 在 [開始] 畫面上選取 [Visual Studio Code] 圖格。 
1. 在 [檔案]**** 功能表上，選取 [開啟資料夾]****。
1. 在開啟的 [檔案總管] 視窗中，瀏覽至 **Allfiles (F):\\Allfiles\\Labs\\02\\Starter\\func**，然後選取 [選取資料夾]。
1. 在 [Visual Studio Code] 視窗的 [Explorer] 窗格中，開啟 **GetSettingInfo.cs** 檔案。
1. 在程式碼編輯器中觀察範例實作情況：

    ```csharp
    using System;
    using System.IO;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Azure.WebJobs;
    using Microsoft.Azure.WebJobs.Extensions.Http;
    using Microsoft.AspNetCore.Http;
    using Microsoft.Extensions.Logging;
    using Newtonsoft.Json;    
    namespace func
    {
        public static class GetSettingInfo
        {
            [FunctionName("GetSettingInfo")]
            public static async Task<IActionResult> Run(
                [HttpTrigger(AuthorizationLevel.Function, "get", "post", Route = null)] HttpRequest req,
                ILogger log)
            {
                log.LogInformation("C# HTTP trigger function processed a request.");    
                string name = req.Query["name"];    
                string requestBody = await new StreamReader(req.Body).ReadToEndAsync();
                dynamic data = JsonConvert.DeserializeObject(requestBody);
                name = name ?? data?.name;    
                string responseMessage = string.IsNullOrEmpty(name)
                    ? "This HTTP triggered function executed successfully. Pass a name in the query string or in the request body for a personalized response."
                    : $"Hello, {name}. This HTTP triggered function executed successfully.";    
                return new OkObjectResult(responseMessage);
            }
        }
    }
    ```

1. 刪除 **GetSettingInfo.cs** 檔案內的所有內容。

1. 新增下列程式碼，即可在 **Microsoft.AspNetCore.Http**、**Microsoft.AspNetCore.Mvc** 和 **Microsoft.Azure.WebJobs** 命名空間中新增 **Using 指示詞**：

    ```csharp
    using Microsoft.AspNetCore.Http;
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Azure.WebJobs;
    ```

1. 建立名為 **GetSettingInfo** 的新**public static**類別：

    ```csharp
    public static class GetSettingInfo
    { }
    ```

1. 再次觀察 **GetSettingInfo.cs** 檔案，現在應該包含下列程式碼：

    ```csharp
    using Microsoft.AspNetCore.Http;
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Azure.WebJobs;
    public static class GetSettingInfo
    { }
    ```

1. 在 **GetSettingInfo** 類別中新增下列程式碼區塊，建立名為 **Run** 的新**public static**運算式主體方法以傳回 **IActionResult** 類型的變數，並接受 **HttpRequest** 和**字串**型別的變數作為參數，分別名為 request和 json：

    ```csharp
    public static IActionResult Run(
        HttpRequest request,
        string json)
        => null;
    ```

    > **注意**：您只是暫時將傳回值設定為 **null**。

1. 新增下列程式碼，將屬性附加至 **FunctionNameAttribute** 型別的 **Run** 方法，其**名稱**參數的值設為 **GetSettingInfo**：

    ```csharp
    [FunctionName("GetSettingInfo")]
    public static IActionResult Run(
        HttpRequest request,
        string json)
        => null;
    ```

1. 新增下列程式碼，將屬性附加至 **HttpTriggerAttribute** 型別的**要求**參數，其**方法**參數陣列設為單一值 **GET**：

    ```csharp
    [FunctionName("GetSettingInfo")]
    public static IActionResult Run(
        [HttpTrigger("GET")] HttpRequest request,
        string json)
        => null;
    ```

1. 新增下列程式碼，將屬性附加至 **BlobAttribute** 型別的 **json** 參數，其 **blobPath** 參數的值設為 **content/settings.json**：

    ```csharp
    [FunctionName("GetSettingInfo")]
    public static IActionResult Run(
        [HttpTrigger("GET")] HttpRequest request,
        [Blob("content/settings.json")] string json)
        => null;
    ```

1. 新增下列程式碼更新 **Run** 運算式主體方法，以傳回 **OkObjectResult** 類別的新執行個體，並傳入 **json** 方法參數的值作為唯一的建構函數參數：

    ```csharp
    [FunctionName("GetSettingInfo")]
    public static IActionResult Run(
        [HttpTrigger("GET")] HttpRequest request,
        [Blob("content/settings.json")] string json)
        => new OkObjectResult(json);
    ```

1. 再次觀察 **GetSettingInfo.cs** 檔案，現在應該包含下列程式碼：

    ```csharp
    using Microsoft.AspNetCore.Http;
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Azure.WebJobs;
    public static class GetSettingInfo
    {
        [FunctionName("GetSettingInfo")]
        public static IActionResult Run(
            [HttpTrigger("GET")] HttpRequest request,
            [Blob("content/settings.json")] string json)
            => new OkObjectResult(json);
    }
    ```

1. 選取 [儲存] 即可將您的變更儲存至 **GetSettingInfo.cs** 檔案。

#### <a name="task-4-register-azure-storage-blob-extensions"></a>工作 4：註冊 Azure 儲存體 Blob 延伸模組

1. 在工作列上，選取 **Windows 終端機**圖示。
1. 執行下列命令，將目前目錄變更為 **Allfiles (F):\\Allfiles\\Labs\\02\\Starter\\func** 目錄：

    ```powershell
    cd F:\Allfiles\Labs\02\Starter\func
    ```

1. 從命令提示字元中，執行下列命令來註冊 [Microsoft.Azure.WebJobs.Extensions.Storage](https://www.nuget.org/packages/Microsoft.Azure.WebJobs.Extensions.Storage/) 延伸模組：

    ```powershell
    func extensions install --package Microsoft.Azure.WebJobs.Extensions.Storage --version 5.0.1
    ```

1. 執行下列命令來組建 .NET 專案，並驗證延伸模組已正確安裝：

    ```powershell
    dotnet build
    ```

1. 關閉 **Windows 終端機**應用程式目前執行中的所有執行個體。

#### <a name="task-5-test-the-function-by-using-httprepl"></a>工作 5：使用 httprepl 來測試函式

1. 在工作列上，選取 **Windows 終端機**圖示。
1. 執行下列命令，將目前目錄變更為 **Allfiles (F):\\Allfiles\\Labs\\02\\Starter\\func** 目錄：

    ```powershell
    cd F:\Allfiles\Labs\02\Starter\func
    ```

1. 從命令提示字元中，執行下列命令來執行函數應用程式專案：

    ```powershell
    func start --build
    ```

    > **注意**：您可以使用 **Azure Functions Core Tools** 檢閱文件以 [在本機啟動函數應用程式專案][azure-functions-core-tools-start-function]。
1. 在工作列上，再次選取 **Windows 終端機**圖示以開啟 **Windows 終端機**應用程式的新執行個體。
1. 從命令提示字元中，執行下列命令來啟動 **httprepl** 工具，將基礎統一資源識別項 (URI) 設為 ``http://localhost:7071``：

    ```powershell
    httprepl http://localhost:7071
    ```

    > **注意**：**httprepl** 工具會顯示錯誤訊息。 會出現此訊息是因為該工具會搜尋要用來周遊 API 的 Swagger 定義檔。 您的函數專案不會產生 Swagger 定義檔，因此您必須手動周遊 API。

1. 當您收到工具提示時，請執行下列命令來瀏覽至相應的 **api** 端點：

    ```powershell
    cd api
    ```

1. 執行下列命令來瀏覽至相應的 **getsettinginfo** 端點：

    ```powershell
    cd getsettinginfo
    ```

1. 執行下列命令來執行目前端點的 **get** 命令：

    ```powershell
    get
    ```

1. 觀察函數應用程式回應的 JSON 內容，現在應該包含：

    ```json
    {
        "version": "0.2.4",
        "root": "/usr/libexec/mews_principal/",
        "device": {
            "id": "21e46d2b2b926cba031a23c6919"
        },
        "notifications": {
            "email": "joseph.price@contoso.com",
            "phone": "(425) 555-0162 x4151"
        }
    }
    ```

1. 執行下列命令即可結束 **httprepl** 應用程式：

    ```powershell
    exit
    ```

1. 關閉 **Windows 終端機**應用程式目前執行中的所有執行個體。

#### <a name="review"></a>檢閱

在此練習中，您建立了可傳回儲存體內 JSON 檔案內容的函數。

### <a name="exercise-6-deploy-a-local-function-project-to-an-azure-functions-app"></a>練習 6：將本機函數專案部署至 Azure Functions 應用程式

#### <a name="task-1-deploy-using-the-azure-functions-core-tools"></a>工作 1：使用 Azure Functions Core Tools 進行部署

1. 在工作列上，選取 **Windows 終端機**圖示。
1. 執行下列命令，將目前目錄變更為 **Allfiles (F):\\Allfiles\\Labs\\02\\Starter\\func** 目錄：

    ```powershell
    cd F:\Allfiles\Labs\02\Starter\func
    ```

1. 從命令提示字元中，執行下列命令以登入 Azure 命令列介面 (CLI)：

    ```powershell
    az login
    ```

1. 在 **Microsoft Edge** 瀏覽器視窗中，輸入您在此實驗中使用的 Microsoft 或 Azure Active Directory 帳戶名稱和密碼，然後選取 [登入]。
1. 返回目前開啟的 [Windows 終端機] 視窗。 等候登入流程完成。
1. 從命令提示字元中，執行下列命令以發佈函數應用程式專案 (將 `<function-app-name>` 預留位置取代為您稍早在本實驗中建立的函數應用程式名稱)：

    ```powershell
    func azure functionapp publish <function-app-name>
    ```

    > **注意**：例如，如果您的**函數應用程式名稱**是 **funclogicstudent**，您的命令會是 ``func azure functionapp publish funclogicstudent``。 您可以使用 **Azure Functions Core Tools** 檢閱文件以 [發佈本機函數應用程式專案][azure-functions-core-tools-publish-azure]。

1. 等候部署完成，再繼續進行實驗。
1. 關閉目前執行中的 **Windows 終端機**應用程式。

#### <a name="task-2-validate-deployment"></a>工作 2：驗證部署

1. 在工作列上選取 **Microsoft Edge** 圖示，然後選取顯示 Azure 入口網站 (<https://portal.azure.com>) 的索引標籤。
1. 在 Azure 入口網站的 [瀏覽] 窗格上，選取 [資源群組] 連結。
1. 在 [資源群組] 窗格上，選取之前在此實驗中建立的 [Serverless] 資源群組。
1. 在 [Serverless] 窗格上，選取您先前在此實驗中建立的 **funcstor**[您的名稱] 函數應用程式。
1. 在 [函數應用程式] 窗格上，選取 [函數] 區段中的 [函數] 選項。
1. 在 [函數] 窗格上選取現有的 **GetSettingInfo** 函數。
1. 在 [函數] 窗格中，選取 [開發人員] 區段中的 [程式碼 + 測試] 選項。
1. 在函數編輯器中選取 [測試/執行]。
1. 在自動顯示的窗格中，選取 [HTTP 方法] 下拉式清單的 **GET**。
1. 選取 [執行] 以測試函數。
1. 在 [HTTP 回應內容] 中，檢閱測試回合的結果。 JSON 內容現在應該包含下列程式碼：

    ```json
    {
        "version": "0.2.4",
        "root": "/usr/libexec/mews_principal/",
        "device": {
            "id": "21e46d2b2b926cba031a23c6919"
        },
        "notifications": {
            "email": "joseph.price@contoso.com",
            "phone": "(425) 555-0162 x4151"
        }
    }
    ```

#### <a name="review"></a>檢閱

在本練習中，您部署了本機函數專案至 Azure Functions 並驗證了該函數可在 Azure 中運作。

### <a name="exercise-7-clean-up-your-subscription"></a>練習 7：清除訂閱

#### <a name="task-1-open-azure-cloud-shell-and-list-resource-groups"></a>工作 1：開啟 Azure Cloud Shell 並列出資源群組

1.  在 Azure 入口網站中，選取 **Cloud Shell** 圖示 ![Cloud Shell 圖示](./media/az204_lab_CloudShell.png) ，開啟新的 Bash 工作階段。 如果 Cloud Shell 預設為 PowerShell 工作階段，請選取 [PowerShell]，然後在下拉式功能表中選取 [Bash]。

    > **注意**：如果這是您第一次啟動 **Cloud Shell**，當系統提示您選取 [Bash] 或 [PowerShell] 時，請選取 [PowerShell]。   系統顯示**您未裝載儲存體**訊息時，請選取此實驗中使用的訂閱，然後選取 [建立儲存體]。

#### <a name="task-2-delete-a-resource-group"></a>工作 2：刪除資源群組

1. 在 [Cloud Shell] 窗格中，執行下列命令刪除**Serverless**資源群組：

    ```powershell
    az group delete --name Serverless --no-wait --yes
    ```
     > **注意**：此命令會以非同步方式執行 (由 --nowait 參數所決定)，所以雖然您可以在同一個 Bash 工作階段中立即執行另一個 Azure CLI 命令，但系統需要幾分鐘才會實際移除資源群組。

1. 關閉入口網站中的 [Cloud Shell] 窗格。

#### <a name="task-3-close-the-active-application"></a>工作 3：關閉作用中的應用程式

- 關閉目前執行中的 Microsoft Edge 應用程式。

#### <a name="review"></a>檢閱

在此練習中，您已移除此實驗室中使用的資源群組，並清除了您的訂閱。
