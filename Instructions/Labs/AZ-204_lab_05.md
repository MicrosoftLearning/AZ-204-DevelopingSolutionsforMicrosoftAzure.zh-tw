---
lab:
  az204Title: 'Lab 05: Deploy compute workloads by using images and containers'
  az204Module: 'Module 05: Implement IaaS solutions'
ms.openlocfilehash: 90e0c7d16ba6c3d49017e595bebf5afdce980ddb
ms.sourcegitcommit: f03e7b74dc287df4209dcac6a42bff3a876f9f09
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/11/2022
ms.locfileid: "146271934"
---
# <a name="lab-05-deploy-compute-workloads-by-using-images-and-containers"></a>實驗 05：使用映像和容器部署計算工作負載

## <a name="microsoft-azure-user-interface"></a>Microsoft Azure 使用者介面

基於 Microsoft 雲端工具的動態性質，您可能會遇到在本訓練內容開發後變更的 Azure UI。 因此，實驗指示可能無法正確對應實驗步驟。

當社群提醒 Microsoft 需要做修改時，我們會更新此訓練課程。 然而，雲端更新經常發生，所以您可能會在此訓練內容更新前遇到 UI 的變更。 **如果發生這種情況，請適應變更，然後視需要在實驗中調整。**

## <a name="instructions"></a>Instructions

### <a name="before-you-start"></a>在您開始使用 Intune 之前

#### <a name="sign-in-to-the-lab-environment"></a>登入實驗室環境

使用下列認證登入您的 Windows 10 虛擬機器 (VM)：

-   使用者名稱：**系統管理員**

-   密碼：**Pa55w.rd**

> **注意**：您的講師會提供連線至虛擬實驗室環境的指示。

#### <a name="review-the-installed-applications"></a>檢閱已安裝的應用程式

尋找 Windows 10 桌面上的工作列。 工作列包含此次實驗中會用到的應用程式圖示，包括：

-   Microsoft Edge

-   檔案總管

## <a name="architecture-diagram"></a>架構圖

![描述使用映像和容器部署計算工作負載的結構圖](./media/Lab05-Diagram.png)

### <a name="exercise-1-create-a-vm-by-using-the-azure-command-line-interface-cli"></a>練習 1：使用 Azure 命令列介面 (CLI) 建立 VM

#### <a name="task-1-open-the-azure-portal"></a>工作 1：開啟 Azure 入口網站

1.  在工作列上，選取 **Microsoft Edge** 圖示。

1. 在開啟的瀏覽器視窗中，瀏覽至 Azure 入口網站 (<https://portal.azure.com>)，然後登入您在此實驗要用的帳戶。

   > **注意**：如果這是您第一次登入 Azure 入口網站，系統會提供入口網站的導覽。 如果您想要跳過導覽，請選取 [開始使用] 即可開始使用入口網站。

#### <a name="task-2-create-a-resource-group"></a>工作 2：建立資源群組

1.  在 Azure 入口網站的 [瀏覽] 窗格中，使用 [搜尋資源、服務和文件] 文字輸入框，搜尋 **資源群組**，然後在結果清單中選取 [資源群組]。 

1.  在 [資源群組] 窗格上，選取 [建立]。 

1.  在 [建立資源群組] 窗格的 [基本] 索引標籤上，執行下列動作，然後選取 [檢閱 + 建立]：

    | 設定                         | 動作                      |
    | ------------------------------- | --------------------------- |
    | [訂閱] 下拉式清單 | 保留預設值。   |
    | [資源群組] 文字輸入框     | 輸入 **ContainerCompute** |
    | [區域] 下拉式清單       | 選取 **(美國) 美國東部**    |

    下列螢幕擷取畫面顯示 [建立資源群組] 窗格上的設定。

    ![[建立資源群組] 窗格](./media/l05_create_a_resource_group.png)

1.  在 [檢閱 + 建立] 索引標籤上，檢閱您在之前步驟中選取的選項。

1.  選取 [建立]，使用您指定的設定建立資源群組。  

    > **注意**：等候建立工作完成，再繼續進行實驗。

#### <a name="task-3-open-azure-cloud-shell"></a>工作 3：開啟 Azure Cloud Shell

1.  在 Azure 入口網站中，選取 **Cloud Shell** 圖示 ![Cloud Shell 圖示](./media/az204_lab_CloudShell.png)，開啟新的 PowerShell 工作階段。 如果 Cloud Shell 預設為 PowerShell 工作階段，請選取 [PowerShell]，然後在下拉式功能表中選取 [Bash]。

    > **注意**：**Cloud Shell** 圖示以大於符號 (\>) 和底線字元 (\_) 表示。

    > **注意**：如果這是您第一次啟動 **Cloud Shell**，當系統提示您選取 [Bash] 或 [PowerShell] 時，請選取 [Bash]。 系統顯示 **您未裝載儲存體** 訊息時，請選取此實驗中使用的訂閱，然後選取 [建立儲存體]。

1.  在入口網站中的 **Cloud Shell** 命令提示字元，執行下列命令取得 Azure CLI 工具的版本：

    ```
    az --version
    ```

#### <a name="task-4-use-the-azure-cli-commands"></a>工作 4：使用 Azure CLI 命令

1.  執行下列命令，取得 CLI 根層級的子群組和命令清單：

    ```
    az --help
    ```

1.  執行下列命令，取得 Azure 虛擬機器的子群組和命令清單：

    ```
    az vm --help
    ```

1.  執行下列命令，取得 **建立虛擬機器** 命令的引數和範例清單：

    ```
    az vm create --help
    ```

1.  執行下列命令，建立具有下列設定的新 **虛擬機器**，請務必記錄以下系統要求您建立的密碼，在稍後的實驗會需要密碼來存取虛擬機器：

    -   資源群組：**ContainerCompute**

    -   名稱：**quickvm**

    -   映像：**Debian**

    -   管理員名稱：**student**

    -   管理員密碼： **\<CreateYourPassword\>**

    >注意：請以您自己的密碼取代下列命令中的 **`<CreateYourPassword>`** 。

    ```
    az vm create --resource-group ContainerCompute --name quickvm --image Debian --admin-username student --admin-password <CreateYourPassword>
    ```

    > **注意**：等候建立 VM。 完成程序後，命令會傳回包含機器詳細資料的 JavaScript 物件標記法 (JSON) 檔案。

1.  執行下列命令，取得更詳細的 JSON 檔案，其中包含新建立 VM 的各種中繼資料：

    ```
    az vm show --resource-group ContainerCompute --name quickvm
    ```

1.  執行下列命令，列出 VM 相關的所有 IP 位址：

    ```
    az vm list-ip-addresses --resource-group ContainerCompute --name quickvm
    ```

1.  執行下列命令來篩選輸出，只傳回第一個 IP 位址值：

    ```
    az vm list-ip-addresses --resource-group ContainerCompute --name quickvm --query '[].{ip:virtualMachine.network.publicIpAddresses[0].ipAddress}' --output tsv
    ```

1.  執行下列命令，將先前命令的結果儲存在名為 ipAddress 的新 Bash 殼層變數中：

    ```
    ipAddress=$(az vm list-ip-addresses --resource-group ContainerCompute --name quickvm --query '[].{ip:virtualMachine.network.publicIpAddresses[0].ipAddress}' --output tsv)
    ```

1.  執行下列命令，以轉譯 Bash 殼層變數 ipAddress 的值：

    ```
    echo $ipAddress
    ```

1.  使用安全殼層 (SSH) 工具和儲存在 Bash 殼層變數 ipAddress 中的 IP 位址，執行下列命令，連線至您之前在此實驗中建立的 VM：

    ```
    ssh student@$ipAddress
    ```

1.  SSH 工具會通知您無法建立主機的真確性，然後詢問您是否要繼續連線。 輸入 **是**，然後選取 [輸入] 繼續連線至 VM。

1.  然後 SSH 工具會要求密碼。 然後輸入您之前建立的密碼，然後選取 [輸入] 使用 VM 驗證。

1.  使用 SSH 連線至 VM 後，請執行下列命令，取得描述 Linux VM 的中繼資料：

    ```
    uname -a
    ```

1.  使用 **exit** 命令結束 SSH 工作階段：

    ```
    exit
    ```

1.  關閉入口網站中的 [Cloud Shell] 窗格。

#### <a name="review"></a>檢閱

在此練習中，您使用了 Cloud Shell 建立 VM 作為自動化指令碼的一部分。

### <a name="exercise-2-create-a-docker-container-image-and-deploy-it-to-azure-container-registry"></a>練習 2：建立並部署 Docker 容器映像至 Azure Container Registry

#### <a name="task-1-open-the-cloud-shell-and-editor"></a>工作 1：開啟 Cloud Shell 和編輯器

1.  在 Azure 入口網站的 [瀏覽] 窗格上，選取 Cloud Shell 圖示，開啟新的殼層執行個體。  

    > **注意**：等候 Cloud Shell 完成執行個體連線，再繼續實驗。

1.  在入口網站中的 [Cloud Shell] 命令提示字元，執行下列命令，從根目錄移至 **\~/clouddrive** 目錄：

    ```
    cd ~/clouddrive
    ```

1.  執行下列命令，在 **\~/clouddrive** 目錄中建立名為 **ipcheck** 的新目錄：

    ```
    mkdir ipcheck
    ```

1.  執行下列命令，將 Active Directory 從 **\~/clouddrive** 變更為 **\~/clouddrive/ipcheck**：

    ```
    cd ~/clouddrive/ipcheck
    ```

1.  執行下列命令，在目前的目錄中建立新的 .NET 主控台應用程式：

    ```
    dotnet new console --output . --name ipcheck
    ```

1.  執行下列命令，在名為 **Dockerfile** 的 **\~/clouddrive/ipcheck** 目錄中建立新檔案：

    ```
    touch Dockerfile
    ```

1.  執行下列命令，在目前目錄的內容中開啟內嵌圖形編輯器：

    ```
    code .
    ```

#### <a name="task-2-create-and-test-a-net-application"></a>工作 2：建立並測試 .NET 應用程式

1.  在圖形編輯器的 [檔案] 窗格上，選取 **Program.cs** 檔案，即可在編輯器中開啟檔案。

1.  刪除 **Program.cs** 檔案的整個內容。

1.  複製下列程式碼並在 **Program.cs** 檔案中貼上：

    ```csharp
    public class Program
    {
        public static void Main(string[] args)
        {        
            // Check if network is available
            if (System.Net.NetworkInformation.NetworkInterface.GetIsNetworkAvailable())
            {
                System.Console.WriteLine("Current IP Addresses:");
                // Get host entry for current hostname
                string hostname = System.Net.Dns.GetHostName();
                System.Net.IPHostEntry host = System.Net.Dns.GetHostEntry(hostname);
                // Iterate over each IP address and render their values
                foreach(System.Net.IPAddress address in host.AddressList)
                {
                    System.Console.WriteLine($"\t{address}");
                }
            }
            else
            {
                System.Console.WriteLine("No Network Connection");
            }
        }
    }
    ```

1.  使用圖形編輯器中的功能表，或 Ctrl+S 鍵盤快速鍵儲存 **Program.cs** 檔案。  請勿關閉圖形編輯器。

1.  回到命令提示字元，執行下列命令以執行應用程式：

    ```
    dotnet run
    ```

1.  檢閱執行的結果。 至少應會列出一個 Cloud Shell 執行個體的 IP 位址。

1.  在圖形編輯器的 [檔案] 窗格上，選取 **Dockerfile** 檔案，即可在編輯器中開啟檔案。

1.  複製下列程式碼並在 **Dockerfile** 檔案中貼上：

    ```
    # Start using the .NET Core 3.1 SDK container image
    FROM mcr.microsoft.com/dotnet/sdk:6.0 AS build

    # Change current working directory
    WORKDIR /app

    # Copy existing files from host machine
    COPY . ./

    # Publish application to the "out" folder
    RUN dotnet publish --configuration Release --output out

    # Start container by running application DLL
    ENTRYPOINT ["dotnet", "out/ipcheck.dll"]
    ```

1.  使用圖形編輯器中的功能表，或使用 Ctrl+S 鍵盤快速鍵儲存 **Dockerfile** 檔案。

1. 保持 Cloud Shell 開啟，以進行下一個工作。

#### <a name="task-3-create-a-container-registry-resource"></a>工作 3：建立容器登錄資源

1. 在入口網站中的 [Cloud Shell] 命令提示字元執行下列命令，建立具有容器登錄資源唯一值的變數： 

    ```bash
    registryName=conregistry$RANDOM
    ```

1. 在入口網站中的 [Cloud Shell] 命令提示字元執行下列命令，驗證上一個步驟中建立的名稱是否可用： 

    ```bash
    az acr check-name --name $registryName
    ```

    如果結果顯示名稱可用，請繼續進行下一個步驟。 如果名稱無法使用，請重新執行上一個步驟中的命令，然後再次驗證可用性。

1. 在入口網站中的 [Cloud Shell] 命令提示字元執行下列命令，建立容器登錄資源： 

    ```bash
    az acr create --resource-group ContainerCompute --name $registryName --sku Basic
    ```

    > **注意**：等候建立工作完成，再繼續進行實驗。

#### <a name="task-4-store-container-registry-metadata"></a>工作 4：儲存容器登錄中繼資料

1.  在入口網站中的 [Cloud Shell] 命令提示字元執行下列命令，取得訂閱中所有容器登錄的清單：

    ```
    az acr list
    ```

1.  執行下列命令，確定輸出顯示的是登錄的名稱。 如果沒看到 '[]' 以外的輸出，請稍候一分鐘，然後嘗試再次執行命令。

    ```
    az acr list --query "max_by([], &creationDate).name" --output tsv
    ```

1.  執行以下命令：

    ```
    acrName=$(az acr list --query "max_by([], &creationDate).name" --output tsv)
    ```

1.  執行以下命令：

    ```
    echo $acrName
    ```

#### <a name="task-5-deploy-a-docker-container-image-to-container-registry"></a>工作 5：部署 Docker 容器映像至容器登錄

1.  執行下列命令，將 Active Directory 從 **\~/** 變更為 **\~/clouddrive/ipcheck**：

    ```
    cd ~/clouddrive/ipcheck
    ```

1.  執行下列命令，取得目前目錄的內容：

    ```
    dir
    ```

1.  執行下列命令，上傳原始程式碼至容器登錄，並組建容器映像為 Container Registry 工作：

    ```
    az acr build --registry $acrName --image ipcheck:latest .
    ```

    > **注意**：等候組建工作完成，再繼續進行實驗。

1.  關閉入口網站中的 [Cloud Shell] 窗格。

#### <a name="task-6-validate-your-container-image-in-container-registry"></a>工作 6：驗證 Container Registry 中的容器映像

1.  在 Azure 入口網站的 [瀏覽] 窗格上，選取 [資源群組] 連結。

1.  從 [資源群組] 窗格，選取之前在此實驗室中建立的 [ContainerCompute] 資源群組。

1.  從 [ContainerCompute] 窗格選取之前在此實驗中建立的容器登錄。

1.  從 [Container Registry] 窗格的 [服務] 區段中，選取 [存放庫] 連結。  

1.  在 [存放庫] 區段中，選取 [ipcheck] 容器映像存放庫，然後選取 [最新] 標籤。  

1.  檢閱包含 [最新] 標籤的容器映像版本中繼資料。

    > **注意**：您也可以選取 [執行識別碼] 連結，尋找組建工作的中繼資料。

#### <a name="review"></a>檢閱

在此練習中，您建立了顯示機器目前 IP 位址的 .NET 主控台應用程式， 然後新增 **Dockerfile** 檔案至應用程式，讓檔案可以轉換為 Docker 容器映像。 最後，部署容器映像至 Container Registry。

### <a name="exercise-3-deploy-an-azure-container-instance"></a>練習 3：部署 Azure 容器執行個體

#### <a name="task-1-enable-the-admin-user-in-container-registry"></a>工作 1：在容器登錄上啟用管理使用者

1.  在 Azure 入口網站的 [瀏覽] 窗格上，選取 [資源群組] 連結。

1.  在 [資源群組] 窗格上，選取之前在此實驗中建立的 [ContainerCompute] 資源群組。

1.  在 [ContainerCompute] 窗格上，選取之前在此實驗中建立的容器登錄，然後選取 [更新]。 

1.  在 [更新容器登錄] 窗格的 [管理使用者] 區段中，選取 [啟用]。  

1.  選取 [儲存]，然後關閉 [更新容器登錄] 窗格。 

#### <a name="task-2-automatically-deploy-a-container-image-to-an-azure-container-instance"></a>工作 2：自動部署容器映像至 Azure 容器執行個體

1.  在 [Container Registry] 窗格的 [服務] 區段中，選取 [存放庫] 連結。  

1.  在 [存放庫] 區段中，選取 [ipcheck] 容器映像存放庫。 

1.  在 [存放庫] 窗格上，選取 [最新] 標籤項目相關的省略符號功能表，然後選取 [執行執行個體]。 

1.  在 [建立容器執行個體] 窗格上，執行下列動作，然後選取 [確定]： 

    | 設定                            | 動作                       |
    | ---------------------------------- | ---------------------------- |
    | [容器名稱] 文字輸入框        | 輸入 **managedcompute**    |
    | [容器映像] 文字輸入框       | 保留預設值。    |
    | [OS 類型] 區段                | 選取 [Linux]            |
    | [訂閱] 文字輸入框          | 保留預設值。    |
    | [資源群組] 下拉式清單  | 選取 [ContainerCompute] |
    | [位置] 下拉式清單        | 選取 [美國東部]          |
    | [核心數目] 下拉式清單 | 選取 [2]                |
    | [記憶體 (GB)] 文字輸入框           | 輸入 **4**                 |
    | [公用 IP 位址] 區段      | 選取 [否]               |

    下列螢幕擷取畫面顯示 [建立容器執行個體] 窗格上的設定。

    ![[建立容器執行個體] 窗格](./media/l05_create_container_instance.png)

    > **注意**：等候容器執行個體建立完成，再繼續進行實驗。

#### <a name="task-3-manually-deploy-a-container-image-to-container-instances"></a>工作 3：手動部署容器映像至容器執行個體

1.  在 Azure 入口網站的 [瀏覽] 窗格上，選取 [建立資源] 連結。 

1.  在 [建立資源] 窗格的 [搜尋服務和市集] 文字輸入框中，輸入 **容器執行個體**，然後選取 [輸入]。 

1.  在 [市集] 搜尋結果窗格上，選取 [容器執行個體] 結果。 

1.  在 [容器執行個體] 窗格上，選取 [建立]。 

1.  在 [建立容器執行個體] 窗格的 [基本] 索引標籤上，執行下列動作，然後選取 [檢閱 + 建立]：

    | 設定 | 動作 |
    | --- | --- |
    | [訂閱] 下拉式清單   | 保留預設值 |
    | [資源群組] 下拉式清單 | 選取 [ContainerCompute] |
    | [容器名稱] 文字輸入框 | 輸入 **manualcompute** |
    | [區域] 下拉式清單 | 選取 **(美國) 美國東部** |
    | [映像來源] 區段 | 選取 [Azure Container Registry] |
    | [登錄] 下拉式清單 | 選取之前在此實驗中建立的 [Azure Container Registry] 資源 |
    | [映像] 下拉式清單 | 選取 **ipcheck** |
    | [映像標籤] 下拉式清單      | 選取 [最新]  |

    下列螢幕擷取畫面顯示 [建立容器執行個體] 窗格上的設定。

    ![[建立容器執行個體] 窗格](./media/l05_create_container_instance_manual.png)

1.  從 [檢閱 + 建立] 索引標籤，檢閱選取的選項。

1.  選取 [建立]，使用您指定的設定建立容器執行個體。  

    > **注意**：等候容器執行個體建立完成，再繼續進行實驗。

#### <a name="task-4-validate-that-the-container-instance-ran-successfully"></a>工作 4：驗證容器執行個體是否已成功執行

1.  在 Azure 入口網站的 [瀏覽] 窗格上，選取 [資源群組] 連結。

1.  在 [資源群組] 窗格上，選取之前在此實驗中建立的 [ContainerCompute] 資源群組。

1.  在 [ContainerCompute] 窗格上，選取之前在此實驗中建立的 [manualcompute] 容器執行個體。 

1.  在 [容器執行個體] 窗格的 [設定] 區段中，選取 [容器] 連結。  

1.  在 [容器] 區段中，檢閱 [事件] 清單。

1.  選取 [記錄] 索引標籤，然後檢閱容器執行個體的文字記錄。

> **注意**：您也可以選擇從 **Managedcompute** 容器執行個體，尋找 **事件** 和 **記錄**。

> **注意**：應用程式完成執行後，容器會終止，因其工作已完成。 如果是手動建立的容器執行個體，由於您已經指示執行成功後的結束是可接受的，所以容器僅執行一次。 自動建立的執行個體並未提供此選項，並假設容器應該持續保持執行，所以您會看到容器反覆重新啟動。

#### <a name="review"></a>檢閱

在此練習中，您使用了多個方法將容器映像部署至 Azure 容器執行個體。 使用手動方法，您可以進一步自訂部署，並將以工作為基礎的應用程式作為容器執行的一部分來執行。

### <a name="exercise-4-clean-up-your-subscription"></a>練習 4：清除訂閱

#### <a name="task-1-open-azure-cloud-shell-and-list-resource-groups"></a>工作 1：開啟 Azure Cloud Shell 並列出資源群組

1.  在 Azure 入口網站中，選取 **Cloud Shell** 圖示 ![Cloud Shell 圖示](./media/az204_lab_CloudShell.png) ，開啟新的 Bash 工作階段。 如果 Cloud Shell 預設為 PowerShell 工作階段，請選取 [PowerShell]，然後在下拉式功能表中選取 [Bash]。

    > **注意**：如果這是您第一次啟動 **Cloud Shell**，當系統提示您選取 [Bash] 或 [PowerShell] 時，請選取 [PowerShell]。   系統顯示 **您未裝載儲存體** 訊息時，請選取此實驗中使用的訂閱，然後選取 [建立儲存體]。

#### <a name="task-2-delete-resource-groups"></a>工作 2：刪除資源群組

1.  在 [Cloud Shell] 窗格上，執行下列命令刪除 **ContainerCompute** 資源群組：

    ```
    az group delete --name ContainerCompute --no-wait --yes
    ```

   > **注意**：此命令會以非同步方式執行 (由 --nowait 參數決定)，所以雖然您可以在同一個 Bash 工作階段中立即執行另一個 Azure CLI 命令，但系統需要幾分鐘才會實際移除資源群組。

1. 關閉入口網站中的 [Cloud Shell] 窗格。

#### <a name="task-3-close-the-active-applications"></a>工作 3：關閉作用中的應用程式

-   關閉目前執行中的 Microsoft Edge 應用程式。

#### <a name="review"></a>檢閱

在此練習中，您已移除此實驗中使用的資源群組，並清除了您的訂閱。
